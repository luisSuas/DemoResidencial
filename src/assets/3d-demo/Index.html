<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="Ricardo Conde">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xJobs - Order Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: #fff;
            /* overflow: hidden; */
    overflow-y: auto;      /*  ← permitimos sólo scroll vertical  */
}
html {
    height: auto;          /*  para que la altura del HTML crezca con el contenido  */
}
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header-details {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .header-item {
            background: rgba(52, 152, 219, 0.2);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        
        .header-item i {
            margin-right: 5px;
            font-size: 16px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.8;
            max-width: 800px;
            line-height: 1.4;
        }
        
        .container {
            display: flex;
            width: 100%;
            padding: 140px 20px 20px;
            transition: all 0.3s ease;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            height: calc(100vh - 160px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-right: 20px;
            transition: all 0.3s ease;
        }
        
        #map-3d {
            width: 100%;
            height: 100%;
        }
        
        .orders-panel {
            width: 350px;
            background: rgba(30, 30, 40, 0.9);
            border-radius: 12px;
            padding: 20px;
             /* -------------------- AÑADE ESTO -------------------- */
            /* Limita la altura al viewport menos el header */
            max-height: calc(100vh - 160px);
            /* Activa scroll vertical cuando el contenido desborda */
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }
        
        .panel-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-header h2 {
            display: flex;
            align-items: center;
            font-size: 22px;
        }
        
        .panel-toggle {
            background: rgba(52, 152, 219, 0.3);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .panel-toggle:hover {
            background: #3498db;
            transform: rotate(180deg);
        }
        
        .order-card {
            background: rgba(40, 40, 50, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: rgba(52, 152, 219, 0.5);
        }
        
        .order-card.selected {
            border-color: #3498db;
            background: rgba(30, 60, 90, 0.7);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .order-id {
            font-weight: bold;
            color: #3498db;
            font-size: 18px;
        }
        
        .order-room {
            background: rgba(52, 152, 219, 0.2);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .order-details {
            margin-bottom: 12px;
        }
        
        .order-details p {
            margin-bottom: 5px;
            font-size: 15px;
        }
        
        .order-problem {
            color: #e74c3c;
            font-weight: 500;
        }
        
        .order-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-pending {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .status-in-progress {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }
        
        .status-completed {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .worker-info {
            display: flex;
            align-items: center;
        }
        
        .worker-icon {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #3498db;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(40, 40, 50, 0.9);
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:hover {
            background: #3498db;
            transform: scale(1.1);
        }
        
        .stats {
            position: absolute;
            top: 120px;
            right: 380px;
            background: rgba(30, 30, 40, 0.8);
            border-radius: 10px;
            padding: 15px;
            z-index: 10;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
        }
        
        .stat-item {
            display: flex;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .stat-value {
            margin-left: auto;
            font-weight: bold;
            color: #3498db;
        }
        
        /* Sidebar */
        .sidebar {
            position: absolute;
            top: 140px;
            right: 20px;
            width: 300px;
            background: rgba(30, 30, 40, 0.9);
            border-radius: 12px;
            padding: 20px;
            z-index: 10;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-toggle {
            background: rgba(231, 76, 60, 0.3);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .sidebar-toggle:hover {
            background: #e74c3c;
        }
        
        .sidebar-content {
            max-height: calc(100vh - 240px);
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .sidebar-section {
            margin-bottom: 20px;
        }
        
        .sidebar-section h3 {
            margin-bottom: 10px;
            color: #3498db;
            display: flex;
            align-items: center;
        }
        
        .sidebar-section h3 i {
            margin-right: 8px;
        }
        
        .sidebar-section ul {
            list-style-type: none;
            padding-left: 15px;
        }
        
        .sidebar-section li {
            margin-bottom: 8px;
            padding-left: 25px;
            position: relative;
        }
        
        .sidebar-section li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #3498db;
            font-size: 20px;
            line-height: 1;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                padding-top: 160px;
            }
            
            .sidebar {
                top: 160px;
            }
        }
        
        @media (max-width: 1000px) {
            .container {
                flex-direction: column;
                padding-top: 180px;
            }
            
            .map-container {
                margin-right: 0;
                margin-bottom: 20px;
                height: 50vh;
            }
            
            .orders-panel {
                width: 100%;
                height: 35vh;
            }
            
            .stats {
                top: 180px;
                right: 20px;
            }
            
            .sidebar {
                top: 180px;
                width: calc(100% - 40px);
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Stuyvesant Town | Order Tracking Panel</h1>
        <p>Real-time management system for tenants and maintenance workers with detailed tracking and analytics</p>
        
        <div class="header-details">
            <div class="header-item">
                <i>🏢</i> Building A - North Wing
            </div>
            <div class="header-item">
                <i>👷</i> 4 Active Workers
            </div>
            <div class="header-item">
                <i>🔄</i> Last update: <span id="last-update"> Just now</span>
            </div>
            <div class="header-item">
                <i>⏱️</i> Response time: < 15 min
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="map-container">
            <div id="map-3d"></div>
            
            <div class="stats">
                <div class="stat-item">
                    <span>Total orders:</span>
                    <span class="stat-value" id="total-orders">8</span>
                </div>
                <div class="stat-item">
                    <span>Pending:</span>
                    <span class="stat-value" id="pending-orders">3</span>
                </div>
                <div class="stat-item">
                    <span>In progress:</span>
                    <span class="stat-value" id="progress-orders">4</span>
                </div>
                <div class="stat-item">
                    <span>Completed:</span>
                    <span class="stat-value" id="completed-orders">1</span>
                </div>
                <div class="stat-item">
                    <span>Avg. resolution:</span>
                    <span class="stat-value" id="avg-resolution">2.3h</span>
                </div>
            </div>
            
            <div class="controls">
                <button class="control-btn" id="zoom-in">+</button>
                <button class="control-btn" id="zoom-out">-</button>
                <button class="control-btn" id="reset-view">↺</button>
            </div>
        </div>
        
        <div class="orders-panel">
            <div class="panel-header">
                <h2>📋 Active Orders</h2>
                <button class="panel-toggle" id="toggle-panel">↔</button>
            </div>
            <div id="orders-container">
                <!-- Order cards will be generated here -->
            </div>
        </div>
    </div>
    
    <!-- Sidebar for additional details -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Environment Details</h2>
            <button class="sidebar-toggle" id="toggle-sidebar">×</button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-section">
                <h3><i>🏗️</i> Building Structure</h3>
                <ul>
                    <li>5 apartment with 500 rooms each</li>
                    <li>Maintenance access points on each floor</li>
                    <li>Emergency exits at both ends</li>
                    <li>Utility rooms on basement level</li>
                </ul>
            </div>
            
            <div class="sidebar-section">
                <h3><i>👥</i> Active Workers</h3>
                <ul>
                    <li>Ricardo Conde (Plumbing specialist)</li>
                    <li>Elliot Fuentes (Electrical systems)</li>
                    <li>Carlos Ramírez (HVAC specialist)</li>
                    <li>María López (General maintenance)</li>
                </ul>
            </div>
            
            <div class="sidebar-section">
                <h3><i>⚠️</i> Critical Areas</h3>
                <ul>
                    <li>Apartment 305 - Water pressure issues</li>
                    <li>North Wing - Electrical maintenance scheduled</li>
                    <li>Apartment 408 - Recurring AC problems</li>
                </ul>
            </div>
            
            <div class="sidebar-section">
                <h3><i>📊</i> Performance Metrics</h3>
                <ul>
                    <li>Average response time: 12 minutes</li>
                    <li>Issue resolution rate: 92%</li>
                    <li>Tenant satisfaction: 4.8/5</li>
                    <li>Monthly maintenance budget: $8,500</li>
                </ul>
            </div>
            
            <div class="sidebar-section">
                <h3><i>🔧</i> Equipment Status</h3>
                <ul>
                    <li>Elevators: All operational</li>
                    <li>Boiler system: Normal</li>
                    <li>Electrical grid: Stable</li>
                    <li>Security systems: Fully functional</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let orders = [
            {
                id: "ORD-001",
                room: "APT1-ROOM-301",
                problem: "Water leak in the bathroom",
                status: "pending",
                createdAt: "2023-06-23 09:15",
                worker: "Ricardo Conde",
                position: { x: 3, y: 1, z: 4 },
                priority: "high",
                details: "Leak coming from under the sink. Water damage to floor."
            },
            {
                id: "ORD-002",
                room: "APT3-ROOM-215",
                problem: "Hallway light not working",
                status: "in-progress",
                createdAt: "2023-06-23 10:30",
                worker: "Elliot Fuentes",
                position: { x: -2, y: 2, z: -3 },
                priority: "medium",
                details: "Entrance hallway completely dark. Safety concern."
            },
            {
                id: "ORD-003",
                room: "APT4-ROOM-102",
                problem: "Broken closet door",
                status: "pending",
                createdAt: "2023-06-23 11:45",
                worker: null,
                position: { x: -4, y: 0, z: -1 },
                priority: "low",
                details: "Sliding door came off track. Needs realignment."
            },
            {
                id: "ORD-004",
                room: "APT9-ROOM-119",
                problem: "Air conditioning does not cool",
                status: "in-progress",
                createdAt: "2023-06-23 12:20",
                worker: "Carlos Ramírez",
                position: { x: 0, y: 4, z: 2 },
                priority: "high",
                details: "AC unit blowing warm air. Filter recently replaced."
            },
            {
                id: "ORD-005",
                room: "APT2-ROOM-305",
                problem: "Toilet not flushing",
                status: "pending",
                createdAt: "2023-06-23 13:45",
                worker: null,
                position: { x: 2, y: 3, z: -2 },
                priority: "medium",
                details: "Handle loose, water not filling tank properly."
            }
        ];

        // Variables globales de Three.js
        let scene, camera, renderer, building, workerMarker;
        let roomMarkers = [];
        let pathLines = [];
        let selectedOrder = null;
        let buildingSize = { width: 20, height: 15, depth: 20 };
        let panelExpanded = false;
        let sidebarVisible = true;

        // Inicializar la aplicación
        function init() {
            initThreeJS();
            renderOrders();
            setupEventListeners();
            simulateRealTimeUpdates();
            
            // Inicializar conexión WebSocket (simulada)
            initSocketConnection();
            
            // Actualizar hora de última actualización
            updateLastUpdated();
        }

        // Configurar Three.js
        function initThreeJS() {
            // Crear escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a192f);
            scene.fog = new THREE.Fog(0x0a192f, 20, 50);

            // Crear cámara
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 25);
            camera.lookAt(0, 0, 0);

            // Crear renderizador
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth * 0.7, window.innerHeight - 100);
            document.getElementById('map-3d').appendChild(renderer.domElement);

            // Configurar luces
            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(10, 20, 15);
            scene.add(directionalLight);

            // Crear edificio
            createBuilding();

            // Crear marcadores de habitaciones
            createRoomMarkers();

            // Crear marcador del trabajador
            createWorkerMarker();

            // Crear ejes de referencia
            const axesHelper = new THREE.AxesHelper(10);
            scene.add(axesHelper);

            // Iniciar animación
            animate();
        }

        // Crear modelo del edificio
        function createBuilding() {
            // Estructura principal
            const geometry = new THREE.BoxGeometry(
                buildingSize.width, 
                buildingSize.height, 
                buildingSize.depth
            );
            
            const edges = new THREE.EdgesGeometry(geometry);
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x3498db, linewidth: 2 });
            building = new THREE.LineSegments(edges, lineMaterial);
            
            // Material transparente para las caras
            const material = new THREE.MeshPhongMaterial({
                color: 0x1a2a6c,
                transparent: true,
                opacity: 0.2,
                side: THREE.DoubleSide
            });
            
            const mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
            scene.add(building);

            // Crear pisos
            createFloors();
        }

        // Crear pisos del edificio
        function createFloors() {
            const floorHeight = buildingSize.height / 5;
            
            for (let i = 1; i <= 5; i++) {
                const floorGeometry = new THREE.PlaneGeometry(buildingSize.width, buildingSize.depth);
                const floorMaterial = new THREE.MeshBasicMaterial({
                    color: 0x2c3e50,
                    transparent: true,
                    opacity: 0.1,
                    side: THREE.DoubleSide
                });
                
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = Math.PI / 2;
                floor.position.y = (i * floorHeight) - (buildingSize.height / 2) - (floorHeight / 2);
                scene.add(floor);
                
                // Etiqueta de piso
                const canvas = document.createElement('canvas');
                canvas.width = 128;
                canvas.height = 32;
                const context = canvas.getContext('2d');
                context.fillStyle = '#3498db';
                context.font = '20px Arial';
                context.fillText(`Floor ${i}`, 10, 22);
                
                const texture = new THREE.CanvasTexture(canvas);
                const labelMaterial = new THREE.SpriteMaterial({ map: texture });
                const label = new THREE.Sprite(labelMaterial);
                label.position.set(-buildingSize.width/2 + 1, (i * floorHeight) - (buildingSize.height / 2) - (floorHeight / 2), -buildingSize.depth/2);
                label.scale.set(4, 1, 1);
                scene.add(label);
            }
        }

        // Crear marcadores para las habitaciones
        function createRoomMarkers() {
            orders.forEach(order => {
                const roomMarker = createRoomMarker(order.position, order.id, order.status);
                scene.add(roomMarker);
                roomMarkers.push({ id: order.id, marker: roomMarker });
            });
        }

        // Crear marcador de habitación individual
        function createRoomMarker(position, id, status) {
            // Color según el estado
            let color;
            switch(status) {
                case 'pending': color = 0xe74c3c; break;
                case 'in-progress': color = 0xf1c40f; break;
                case 'completed': color = 0x2ecc71; break;
                default: color = 0x3498db;
            }
            
            // Esfera para representar la habitación
            const geometry = new THREE.SphereGeometry(0.4, 16, 16);
            const material = new THREE.MeshBasicMaterial({ 
                color: color,
                transparent: true,
                opacity: 0.8
            });
            
            const marker = new THREE.Mesh(geometry, material);
            marker.position.set(position.x, position.y, position.z);
            marker.userData = { id: id };
            
            // Añadir etiqueta
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 32;
            const context = canvas.getContext('2d');
            context.fillStyle = '#ffffff';
            context.font = 'bold 16px Arial';
            context.fillText(id, 10, 22);
            
            const texture = new THREE.CanvasTexture(canvas);
            const labelMaterial = new THREE.SpriteMaterial({ map: texture });
            const label = new THREE.Sprite(labelMaterial);
            label.position.set(position.x, position.y + 1, position.z);
            label.scale.set(3, 0.8, 1);
            marker.add(label);
            
            return marker;
        }

        // Crear marcador del trabajador
        function createWorkerMarker() {
            const geometry = new THREE.ConeGeometry(0.3, 1, 8);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x3498db,
                transparent: true,
                opacity: 0.9
            });
            
            workerMarker = new THREE.Mesh(geometry, material);
            workerMarker.rotation.x = Math.PI;
            workerMarker.position.set(0, -buildingSize.height/2 + 0.5, 0);
            scene.add(workerMarker);
        }

        // Mover trabajador a una posición
        function moveWorkerTo(position, duration = 3000) {
            const startPosition = workerMarker.position.clone();
            const endPosition = new THREE.Vector3(position.x, position.y, position.z);
            const startTime = Date.now();
            
            function animateMove() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Interpolación lineal
                workerMarker.position.lerpVectors(startPosition, endPosition, progress);
                
                if (progress < 1) {
                    requestAnimationFrame(animateMove);
                }
            }
            
            animateMove();
        }

        // Renderizar las órdenes en el panel
        function renderOrders() {
            const container = document.getElementById('orders-container');
            container.innerHTML = '';
            
            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = `order-card ${selectedOrder?.id === order.id ? 'selected' : ''}`;
                card.dataset.id = order.id;
                
                let statusText, statusClass;
                switch(order.status) {
                    case 'pending':
                        statusText = 'Pending';
                        statusClass = 'status-pending';
                        break;
                    case 'in-progress':
                        statusText = 'In Progress';
                        statusClass = 'status-in-progress';
                        break;
                    case 'completed':
                        statusText = 'Completed';
                        statusClass = 'status-completed';
                        break;
                }
                
                // Priority indicator
                let priorityIcon = '';
                if (order.priority === 'high') priorityIcon = '🔴 ';
                if (order.priority === 'medium') priorityIcon = '🟠 ';
                if (order.priority === 'low') priorityIcon = '🟢 ';
                
                card.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">${order.id}</div>
                        <div class="order-room">${order.room}</div>
                    </div>
                    <div class="order-details">
                        <p><strong>Issue:</strong> ${priorityIcon}${order.problem}</p>
                        <p><strong>Created:</strong> ${order.createdAt}</p>
                        ${order.details ? `<p class="order-problem">${order.details}</p>` : ''}
                    </div>
                    <div class="order-status">
                        <div class="status-badge ${statusClass}">${statusText}</div>
                        ${order.worker ? `
                            <div class="worker-info">
                                <div class="worker-icon">👷</div>
                                <div>${order.worker}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            updateStats();
        }

        // Actualizar estadísticas
        function updateStats() {
            const total = orders.length;
            const pending = orders.filter(o => o.status === 'pending').length;
            const progress = orders.filter(o => o.status === 'in-progress').length;
            const completed = orders.filter(o => o.status === 'completed').length;
            
            document.getElementById('total-orders').textContent = total;
            document.getElementById('pending-orders').textContent = pending;
            document.getElementById('progress-orders').textContent = progress;
            document.getElementById('completed-orders').textContent = completed;
            
            // Calculate average resolution time
            const completedOrders = orders.filter(o => o.status === 'completed');
            if (completedOrders.length > 0) {
                const avgHours = (completedOrders.reduce((sum, order) => {
                    // Simulated resolution time based on priority
                    const baseTime = order.priority === 'high' ? 1.5 : order.priority === 'medium' ? 3 : 4.5;
                    return sum + baseTime;
                }, 0) / completedOrders.length).toFixed(1);
                
                document.getElementById('avg-resolution').textContent = `${avgHours}h`;
            }
        }
        
        // Update last updated time
        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('last-update').textContent = timeString;
        }

        // Configurar listeners de eventos
        function setupEventListeners() {
            // Seleccionar orden al hacer clic en la tarjeta
            document.getElementById('orders-container').addEventListener('click', (e) => {
                const card = e.target.closest('.order-card');
                if (card) {
                    const orderId = card.dataset.id;
                    selectOrder(orderId);
                }
            });
            
            // Controles de cámara
            document.getElementById('zoom-in').addEventListener('click', () => {
                camera.position.y -= 2;
                camera.position.z -= 2;
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                camera.position.y += 2;
                camera.position.z += 2;
            });
            
            document.getElementById('reset-view').addEventListener('click', () => {
                camera.position.set(0, 15, 25);
                camera.lookAt(0, 0, 0);
            });
            
            // Toggle orders panel
            document.getElementById('toggle-panel').addEventListener('click', () => {
                panelExpanded = !panelExpanded;
                const panel = document.querySelector('.orders-panel');
                if (panelExpanded) {
                    panel.style.width = '450px';
                    document.querySelector('.map-container').style.marginRight = '20px';
                } else {
                    panel.style.width = '350px';
                    document.querySelector('.map-container').style.marginRight = '20px';
                }
            });
            
            // Toggle sidebar
            document.getElementById('toggle-sidebar').addEventListener('click', () => {
                sidebarVisible = !sidebarVisible;
                const sidebar = document.getElementById('sidebar');
                if (sidebarVisible) {
                    sidebar.style.transform = 'translateX(0)';
                } else {
                    sidebar.style.transform = 'translateX(100%)';
                }
            });
            
            // Redimensionar
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth * 0.7, window.innerHeight - 100);
            });
        }

        // Seleccionar una orden
        function selectOrder(orderId) {
            selectedOrder = orders.find(order => order.id === orderId);
            
            // Actualizar UI
            document.querySelectorAll('.order-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.order-card[data-id="${orderId}"]`).classList.add('selected');
            
            // Mover trabajador a esa posición
            if (selectedOrder && selectedOrder.status !== 'pending') {
                moveWorkerTo(selectedOrder.position);
                
                // Crear ruta visual
                createPath(workerMarker.position, selectedOrder.position);
            }
            
            // Centrar cámara en la habitación
            camera.position.set(
                selectedOrder.position.x, 
                selectedOrder.position.y + 8, 
                selectedOrder.position.z + 12
            );
            camera.lookAt(
                selectedOrder.position.x, 
                selectedOrder.position.y, 
                selectedOrder.position.z
            );
        }

        // Crear ruta visual
        function createPath(start, end) {
            // Limpiar rutas anteriores
            pathLines.forEach(line => scene.remove(line));
            pathLines = [];
            
            // Crear línea
            const points = [
                new THREE.Vector3(start.x, start.y, start.z),
                new THREE.Vector3(end.x, end.y, end.z)
            ];
            
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ 
                color: 0x3498db,
                transparent: true,
                opacity: 0.7,
                linewidth: 2
            });
            
            const line = new THREE.Line(geometry, material);
            scene.add(line);
            pathLines.push(line);
            
            // Flecha de dirección
            const direction = new THREE.Vector3().subVectors(end, start).normalize();
            const arrowHelper = new THREE.ArrowHelper(
                direction, 
                start, 
                start.distanceTo(end), 
                0x3498db,
                0.5,
                0.3
            );
            scene.add(arrowHelper);
            pathLines.push(arrowHelper);
        }

        // Simular actualizaciones en tiempo real
        function simulateRealTimeUpdates() {
            setInterval(() => {
                // Simular cambio de estado
                if (Math.random() > 0.7) {
                    const pendingOrders = orders.filter(o => o.status === 'pending');
                    if (pendingOrders.length > 0) {
                        const order = pendingOrders[Math.floor(Math.random() * pendingOrders.length)];
                        order.status = 'in-progress';
                        order.worker = ['Ricardo Conde', 'Elliot Fuentes', 'Carlos Ramírez', 'María López'][Math.floor(Math.random() * 4)];
                        
                        // Actualizar marcador en el mapa
                        const markerInfo = roomMarkers.find(m => m.id === order.id);
                        if (markerInfo) {
                            scene.remove(markerInfo.marker);
                            const newMarker = createRoomMarker(order.position, order.id, order.status);
                            scene.add(newMarker);
                            markerInfo.marker = newMarker;
                        }
                        
                        renderOrders();
                        updateLastUpdated();
                    }
                }
                
                // Simular orden completada
                if (Math.random() > 0.8) {
                    const inProgressOrders = orders.filter(o => o.status === 'in-progress');
                    if (inProgressOrders.length > 0) {
                        const order = inProgressOrders[Math.floor(Math.random() * inProgressOrders.length)];
                        order.status = 'completed';
                        
                        // Actualizar marcador en el mapa
                        const markerInfo = roomMarkers.find(m => m.id === order.id);
                        if (markerInfo) {
                            scene.remove(markerInfo.marker);
                            const newMarker = createRoomMarker(order.position, order.id, order.status);
                            scene.add(newMarker);
                            markerInfo.marker = newMarker;
                        }
                        
                        renderOrders();
                        updateLastUpdated();
                    }
                }
                
                // Simular nueva orden
                if (Math.random() > 0.9) {
                    const newId = `ORD-${String(orders.length + 1).padStart(3, '0')}`;
                    const floors = [0, 1, 2, 3, 4];
                    const problems = [
                        'Broken pipe in kitchen', 
                        'Electrical outlet not working', 
                        'Window won\'t close properly',
                        'Heater making strange noise',
                        'Bathroom drain clogged'
                    ];
                    
                    const priorities = ['high', 'medium', 'low'];
                    
                    const newOrder = {
                        id: newId,
                        room: `HAB-APT${Math.floor(Math.random()*10)+1}-ROOM-${Math.floor(Math.random()*400)+100}`,
                        problem: problems[Math.floor(Math.random() * problems.length)],
                        status: "pending",
                        createdAt: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        worker: null,
                        position: { 
                            x: Math.random() * buildingSize.width/2 * (Math.random() > 0.5 ? 1 : -1),
                            y: floors[Math.floor(Math.random() * 5)] * (buildingSize.height/5) - buildingSize.height/2 + 1,
                            z: Math.random() * buildingSize.depth/2 * (Math.random() > 0.5 ? 1 : -1)
                        },
                        priority: priorities[Math.floor(Math.random() * 3)],
                        details: "Issue reported by tenant. Requires immediate attention."
                    };
                    
                    orders.push(newOrder);
                    
                    // Crear marcador en el mapa
                    const marker = createRoomMarker(newOrder.position, newOrder.id, newOrder.status);
                    scene.add(marker);
                    roomMarkers.push({ id: newOrder.id, marker: marker });
                    
                    renderOrders();
                    updateLastUpdated();
                }
                
            }, 5000); // Actualizar cada 5 segundos
        }

        // Inicializar conexión WebSocket (simulada)
        function initSocketConnection() {
            console.log("Connecting to WebSocket server...");
            // In a real implementation, this would connect to the server
            // const socket = io('http://yourserver.com');
            
            // Simulate successful connection
            setTimeout(() => {
                console.log("WebSocket connection established. Receiving real-time updates...");
            }, 1500);
        }

        // Función de animación
        function animate() {
            requestAnimationFrame(animate);
            
            // Rotación del trabajador
            if (workerMarker) {
                workerMarker.rotation.y += 0.01;
            }
            
            renderer.render(scene, camera);
        }

        // Iniciar la aplicación cuando la página cargue
        window.addEventListener('load', init);
    </script>
</body>
</html>